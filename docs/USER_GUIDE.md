# AI工作流系统 - 用户指南

## 目录

- [1. 快速开始](#1-快速开始)
- [2. 功能介绍](#2-功能介绍)
- [3. 使用教程](#3-使用教程)
- [4. 节点详细说明](#4-节点详细说明)
- [5. 常见问题](#5-常见问题)
- [6. 最佳实践](#6-最佳实践)

---

## 1. 快速开始

### 1.1 系统要求

- **操作系统**: Windows 10/11, macOS 10.15+, Linux (Ubuntu 20.04+)
- **Node.js**: 18.0 或更高版本
- **浏览器**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **内存**: 至少 4GB RAM
- **磁盘空间**: 至少 500MB 可用空间

### 1.2 安装步骤

#### 方式一：从源码安装

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd ai-workflow-system
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

3. **配置环境变量**
   
   在项目根目录创建 `.env` 文件（可选）：
   ```env
   PORT=3000
   CLIENT_PORT=5173
   ```

4. **启动开发服务器**
   ```bash
   npm run dev
   ```

   这将同时启动前端（默认端口 5173）和后端（默认端口 3000）服务。

#### 方式二：使用构建版本

1. **构建项目**
   ```bash
   npm run build
   ```

2. **启动生产服务器**
   ```bash
   cd server
   npm start
   ```

3. **访问应用**
   
   打开浏览器访问 `http://localhost:3000`

### 1.3 首次运行

1. **访问应用**
   
   在浏览器中打开 `http://localhost:5173`（开发模式）

2. **配置 API**
   
   首次使用需要配置 AI API：
   - 点击左侧菜单的"API 配置"
   - 点击"添加 API 配置"按钮
   - 填写 API 信息（详见 [3.2 配置AI API](#32-配置ai-api)）

3. **创建第一个工作流**
   
   - 点击"工作流"菜单
   - 点击"新建工作流"按钮
   - 开始拖拽节点构建工作流

### 1.4 基本配置

#### 文件存储位置

- **工作流定义**: `server/data/workflows/`
- **API 配置**: `server/data/configs/`
- **上传文件**: `server/uploads/`
- **执行历史**: `server/data/executions/`

#### 端口配置

如需修改端口，编辑以下文件：

- **后端端口**: `server/src/index.ts` 中的 `PORT` 变量
- **前端端口**: `client/vite.config.ts` 中的 `server.port` 配置

---

## 2. 功能介绍

### 2.1 工作流编辑器

工作流编辑器是系统的核心功能，基于 React Flow 构建，提供直观的可视化编程体验。

**主要功能**：
- **节点拖拽**: 从左侧节点面板拖拽节点到画布
- **连接节点**: 拖拽节点的输出端口到另一个节点的输入端口
- **节点配置**: 选中节点后在右侧属性面板配置参数
- **画布操作**: 
  - 鼠标滚轮缩放
  - 拖拽画布移动视图
  - 框选多个节点
  - 删除节点（选中后按 Delete 键）

**工具栏功能**：
- **保存**: 保存当前工作流
- **执行**: 运行工作流
- **导出**: 导出工作流为 JSON 文件
- **导入**: 从 JSON 文件导入工作流
- **清空**: 清空画布上的所有节点

### 2.2 节点类型说明

系统提供 6 种核心节点类型：

#### 输入节点
- **文本输入节点**: 输入文本内容
- **图片输入节点**: 上传图片或输入图片 URL

#### 处理节点
- **文本合并节点**: 合并多个文本输入
- **AI生图节点**: 使用 AI API 生成图片

#### 输出节点
- **文本输出节点**: 显示文本结果
- **图片输出节点**: 显示和下载图片

### 2.3 API 配置管理

支持多种 AI API 提供商：

- **OpenAI**: DALL-E 图像生成
- **OpenRouter**: 多模型聚合平台
- **OpenAI 兼容**: 任何兼容 OpenAI API 格式的服务
- **自定义 API**: 完全自定义的 API 端点

**配置项**：
- API 名称
- API 类型
- Base URL
- API Key（加密存储）
- 默认模型
- 超时时间
- 重试次数
- 速率限制

### 2.4 执行历史查看

查看所有工作流的执行记录：

- **执行状态**: pending（等待）、running（运行中）、completed（完成）、failed（失败）
- **执行时间**: 开始时间和结束时间
- **节点结果**: 每个节点的输出结果
- **错误信息**: 失败时的详细错误信息

---

## 3. 使用教程

### 3.1 创建第一个工作流

让我们创建一个简单的文本处理工作流：

1. **进入编辑器**
   - 点击"工作流"菜单
   - 点击"新建工作流"
   - 输入工作流名称和描述

2. **添加文本输入节点**
   - 从左侧节点面板拖拽"文本输入"节点到画布
   - 选中节点，在右侧属性面板输入文本内容

3. **添加文本输出节点**
   - 拖拽"文本输出"节点到画布
   - 连接文本输入节点的输出端口到文本输出节点的输入端口

4. **保存并执行**
   - 点击工具栏的"保存"按钮
   - 点击"执行"按钮运行工作流
   - 在文本输出节点查看结果

### 3.2 配置 AI API

#### 配置 OpenAI

1. **获取 API Key**
   - 访问 [OpenAI Platform](https://platform.openai.com/)
   - 注册账号并创建 API Key

2. **添加配置**
   - 进入"API 配置"页面
   - 点击"添加 API 配置"
   - 填写以下信息：
     ```
     名称: OpenAI DALL-E
     类型: OpenAI
     Base URL: https://api.openai.com/v1
     API Key: sk-xxxxxxxxxxxxxxxx
     默认模型: dall-e-3
     ```

3. **测试连接**
   - 点击"测试"按钮验证配置是否正确

#### 配置 OpenRouter

1. **获取 API Key**
   - 访问 [OpenRouter](https://openrouter.ai/)
   - 注册并获取 API Key

2. **添加配置**
   ```
   名称: OpenRouter
   类型: OpenRouter
   Base URL: https://openrouter.ai/api/v1
   API Key: sk-or-xxxxxxxxxxxxxxxx
   默认模型: stabilityai/stable-diffusion-xl
   ```

#### 配置自定义 API

对于其他兼容 OpenAI 格式的 API：

```
名称: 自定义 API
类型: OpenAI 兼容
Base URL: https://your-api-endpoint.com/v1
API Key: your-api-key
默认模型: your-model-name
```

### 3.3 构建简单的文本处理工作流

创建一个文本合并工作流：

1. **添加两个文本输入节点**
   - 节点 1: 输入 "Hello"
   - 节点 2: 输入 "World"

2. **添加文本合并节点**
   - 配置分隔符为空格 " "

3. **连接节点**
   - 文本输入 1 → 文本合并节点（输入1）
   - 文本输入 2 → 文本合并节点（输入2）

4. **添加文本输出节点**
   - 文本合并节点 → 文本输出节点

5. **执行工作流**
   - 结果应显示 "Hello World"

### 3.4 构建 AI 生图工作流

创建一个 AI 图像生成工作流：

1. **添加文本输入节点**
   - 输入提示词，例如：
     ```
     A beautiful sunset over mountains, digital art, highly detailed
     ```

2. **添加 AI 生图节点**
   - 选择已配置的 API
   - 选择模型（如 dall-e-3）
   - 配置参数：
     - 尺寸: 1024x1024
     - 质量: standard 或 hd
     - 风格: vivid 或 natural

3. **连接节点**
   - 文本输入节点 → AI 生图节点（prompt 输入）

4. **添加图片输出节点**
   - AI 生图节点 → 图片输出节点

5. **执行工作流**
   - 点击执行按钮
   - 等待 AI 生成图片（通常需要 10-30 秒）
   - 在图片输出节点查看和下载结果

### 3.5 导入导出工作流

#### 导出工作流

1. 在编辑器中打开要导出的工作流
2. 点击工具栏的"导出"按钮
3. 工作流将以 JSON 文件下载到本地

#### 导入工作流

1. 点击工具栏的"导入"按钮
2. 选择之前导出的 JSON 文件
3. 工作流将加载到画布上

**工作流文件格式**：
```json
{
  "id": "workflow-id",
  "name": "工作流名称",
  "description": "工作流描述",
  "nodes": [...],
  "edges": [...],
  "createdAt": "2026-02-11T00:00:00.000Z",
  "updatedAt": "2026-02-11T00:00:00.000Z"
}
```

---

## 4. 节点详细说明

### 4.1 文本输入节点

**功能**: 提供文本输入

**输出端口**:
- `text` (文本类型): 输出输入的文本内容

**配置项**:
- **文本内容**: 要输入的文本
- **多行模式**: 是否启用多行文本输入

**使用场景**:
- AI 生图的提示词
- 文本合并的源文本
- 任何需要文本输入的场景

**示例配置**:
```
文本内容: "A serene landscape with mountains"
多行模式: 否
```

### 4.2 图片输入节点

**功能**: 提供图片输入

**输出端口**:
- `image` (图片类型): 输出图片的 URL 或文件路径

**配置项**:
- **输入方式**: 
  - 上传文件: 从本地上传图片
  - URL: 输入图片的网络地址
- **图片预览**: 显示当前选择的图片

**支持格式**:
- JPEG (.jpg, .jpeg)
- PNG (.png)
- WebP (.webp)
- GIF (.gif)

**文件大小限制**: 最大 10MB

**使用场景**:
- 图片编辑工作流的输入
- 图片风格转换
- 图片分析

### 4.3 文本输出节点

**功能**: 显示文本结果

**输入端口**:
- `text` (文本类型): 接收要显示的文本

**配置项**:
- **显示格式**: 
  - 纯文本
  - Markdown
  - JSON（格式化显示）

**功能**:
- 实时显示文本内容
- 复制到剪贴板
- 导出为文本文件

**使用场景**:
- 显示工作流的最终文本结果
- 调试中间文本输出
- 查看 AI 生成的文本

### 4.4 图片输出节点

**功能**: 显示和下载图片

**输入端口**:
- `image` (图片类型): 接收要显示的图片

**配置项**:
- **显示尺寸**: 
  - 原始大小
  - 适应容器
  - 自定义尺寸

**功能**:
- 图片预览
- 下载图片
- 查看图片信息（尺寸、格式、大小）

**使用场景**:
- 显示 AI 生成的图片
- 查看图片处理结果
- 下载最终图片

### 4.5 文本合并节点

**功能**: 合并多个文本输入

**输入端口**:
- `input1` (文本类型): 第一个文本输入
- `input2` (文本类型): 第二个文本输入
- `input3` (文本类型，可选): 第三个文本输入
- `input4` (文本类型，可选): 第四个文本输入

**输出端口**:
- `output` (文本类型): 合并后的文本

**配置项**:
- **分隔符**: 文本之间的分隔符
  - 空格 " "
  - 逗号 ","
  - 换行符 "\n"
  - 自定义

**使用场景**:
- 组合多个提示词
- 构建复杂的文本模板
- 拼接文本片段

**示例**:
```
输入1: "A beautiful"
输入2: "sunset"
输入3: "over mountains"
分隔符: " "
输出: "A beautiful sunset over mountains"
```

### 4.6 AI 生图节点

**功能**: 使用 AI API 生成图片

**输入端口**:
- `prompt` (文本类型): 图片生成提示词
- `negativePrompt` (文本类型，可选): 负面提示词（某些模型支持）

**输出端口**:
- `image` (图片类型): 生成的图片 URL

**配置项**:
- **API 配置**: 选择要使用的 API
- **模型**: 选择生成模型
  - OpenAI: dall-e-2, dall-e-3
  - Stable Diffusion: sd-xl, sd-1.5 等
- **尺寸**: 图片尺寸
  - 256x256, 512x512, 1024x1024
  - 1024x1792, 1792x1024（DALL-E 3）
- **质量**: 
  - standard: 标准质量
  - hd: 高清质量（DALL-E 3）
- **风格**: 
  - vivid: 鲜艳风格
  - natural: 自然风格
- **数量**: 生成图片数量（1-10）

**使用场景**:
- AI 艺术创作
- 概念设计
- 产品原型图生成
- 营销素材制作

**提示词技巧**:
- 详细描述场景、风格、光照
- 使用艺术风格关键词（如 "digital art", "oil painting"）
- 指定质量关键词（如 "highly detailed", "4k"）
- 避免模糊或矛盾的描述

**示例提示词**:
```
A futuristic city at night, neon lights, cyberpunk style, 
highly detailed, digital art, 4k, cinematic lighting
```

---

## 5. 常见问题

### 5.1 API 配置问题

#### Q: API Key 无效怎么办？

**A**: 
1. 检查 API Key 是否正确复制（注意空格）
2. 确认 API Key 是否已激活
3. 检查 API 账户是否有余额
4. 验证 Base URL 是否正确

#### Q: 如何测试 API 配置是否正确？

**A**: 
1. 在 API 配置页面点击"测试"按钮
2. 系统会发送一个测试请求
3. 查看返回的状态和错误信息

#### Q: 支持哪些 AI 图像生成服务？

**A**: 
- OpenAI DALL-E 2/3
- OpenRouter（支持多种模型）
- 任何兼容 OpenAI API 格式的服务
- 可以通过自定义 API 类型添加其他服务

### 5.2 工作流执行失败

#### Q: 工作流执行失败，显示"节点连接无效"？

**A**: 
1. 检查所有节点是否正确连接
2. 确保输入端口的类型与输出端口匹配
3. 检查必需的输入端口是否都已连接

#### Q: AI 生图节点执行超时？

**A**: 
1. AI 生成通常需要 10-30 秒，请耐心等待
2. 检查网络连接是否稳定
3. 在 API 配置中增加超时时间
4. 检查 API 服务是否正常

#### Q: 图片上传失败？

**A**: 
1. 检查图片大小是否超过 10MB
2. 确认图片格式是否支持（JPEG, PNG, WebP, GIF）
3. 检查磁盘空间是否充足
4. 查看浏览器控制台的错误信息

### 5.3 性能优化建议

#### Q: 工作流执行很慢怎么办？

**A**: 
1. **减少不必要的节点**: 简化工作流结构
2. **使用缓存**: 相同输入的节点结果会被缓存
3. **优化图片大小**: 使用较小的图片尺寸
4. **并行执行**: 无依赖关系的节点会自动并行执行

#### Q: 画布上节点太多，操作卡顿？

**A**: 
1. 将复杂工作流拆分为多个子工作流
2. 使用浏览器的硬件加速
3. 关闭不必要的浏览器扩展
4. 增加浏览器内存限制

### 5.4 故障排除

#### Q: 前端无法连接后端？

**A**: 
1. 检查后端服务是否正常运行
2. 确认端口配置是否正确
3. 检查防火墙设置
4. 查看浏览器控制台的网络错误

#### Q: 工作流保存失败？

**A**: 
1. 检查磁盘空间是否充足
2. 确认 `server/data/workflows/` 目录是否存在
3. 检查文件权限
4. 查看服务器日志

#### Q: 执行历史记录丢失？

**A**: 
1. 执行历史存储在 `server/data/executions/`
2. 检查该目录是否存在
3. 确认文件未被误删
4. 可以从备份恢复

#### Q: 如何查看详细的错误日志？

**A**: 
1. **前端日志**: 打开浏览器开发者工具（F12）→ Console
2. **后端日志**: 查看终端输出或 `server/logs/` 目录
3. **执行日志**: 在执行历史页面查看具体执行的错误信息

---

## 6. 最佳实践

### 6.1 工作流设计建议

#### 模块化设计
- 将复杂工作流拆分为多个小的、可重用的工作流
- 每个工作流专注于单一功能
- 使用清晰的命名约定

#### 节点组织
- 从左到右排列节点（输入 → 处理 → 输出）
- 保持节点之间的间距一致
- 使用对齐功能保持整洁

#### 错误处理
- 为关键节点添加输出节点以便调试
- 使用文本输出节点查看中间结果
- 保存工作流的多个版本

### 6.2 性能优化技巧

#### 减少 API 调用
- 使用缓存避免重复调用
- 批量处理多个请求
- 合理设置重试次数

#### 图片优化
- 使用适当的图片尺寸（不要过大）
- 压缩图片以减少传输时间
- 考虑使用 WebP 格式

#### 工作流优化
- 移除未使用的节点
- 简化节点连接
- 利用并行执行能力

### 6.3 安全注意事项

#### API Key 安全
- 不要在工作流中硬编码 API Key
- 定期更换 API Key
- 不要分享包含 API Key 的配置文件

#### 文件安全
- 不要上传敏感图片
- 定期清理上传文件
- 注意文件大小限制

#### 数据隐私
- 了解 AI 服务的数据使用政策
- 不要输入个人敏感信息
- 考虑使用本地部署的 AI 模型

### 6.4 提示词编写技巧

#### 结构化提示词
```
[主题] + [风格] + [细节] + [质量]

示例:
A majestic dragon (主题)
in fantasy art style (风格)
with detailed scales and glowing eyes (细节)
highly detailed, 4k, cinematic lighting (质量)
```

#### 使用权重和强调
- 使用括号增加权重: `(important detail)`
- 使用多个括号进一步强调: `((very important))`

#### 负面提示词
指定不想要的元素：
```
Negative: blurry, low quality, distorted, ugly, bad anatomy
```

#### 风格关键词
- 艺术风格: digital art, oil painting, watercolor, sketch
- 时代风格: modern, vintage, retro, futuristic
- 艺术家风格: in the style of [artist name]

### 6.5 工作流模板建议

#### 基础文本生图
```
文本输入 → AI生图 → 图片输出
```

#### 多提示词组合
```
文本输入1 ┐
文本输入2 ├→ 文本合并 → AI生图 → 图片输出
文本输入3 ┘
```

#### 批量生成
```
文本输入 → AI生图(数量=4) → 图片输出
```

---

## 附录

### A. 快捷键

- `Delete`: 删除选中的节点
- `Ctrl/Cmd + S`: 保存工作流
- `Ctrl/Cmd + Z`: 撤销
- `Ctrl/Cmd + Y`: 重做
- `Ctrl/Cmd + A`: 全选节点
- `Ctrl/Cmd + C`: 复制节点
- `Ctrl/Cmd + V`: 粘贴节点

### B. 支持的图片格式

| 格式 | 扩展名 | 最大尺寸 | 说明 |
|------|--------|----------|------|
| JPEG | .jpg, .jpeg | 10MB | 最常用的图片格式 |
| PNG | .png | 10MB | 支持透明背景 |
| WebP | .webp | 10MB | 现代高效格式 |
| GIF | .gif | 10MB | 支持动画 |

### C. API 模型对照表

#### OpenAI DALL-E
| 模型 | 支持尺寸 | 质量 | 说明 |
|------|----------|------|------|
| dall-e-2 | 256x256, 512x512, 1024x1024 | standard | 较快，成本较低 |
| dall-e-3 | 1024x1024, 1024x1792, 1792x1024 | standard, hd | 质量更高 |

#### Stable Diffusion (via OpenRouter)
| 模型 | 说明 |
|------|------|
| stabilityai/stable-diffusion-xl | SDXL 基础模型 |
| stabilityai/stable-diffusion-2-1 | SD 2.1 模型 |

### D. 错误代码说明

| 错误代码 | 说明 | 解决方案 |
|----------|------|----------|
| 400 | 请求参数错误 | 检查节点配置 |
| 401 | API Key 无效 | 更新 API 配置 |
| 403 | 权限不足 | 检查 API 账户权限 |
| 429 | 请求过于频繁 | 降低请求频率或升级套餐 |
| 500 | 服务器错误 | 稍后重试或联系支持 |
| 503 | 服务不可用 | 检查 API 服务状态 |

---

**文档版本**: 1.0  
**最后更新**: 2026-02-11  
**反馈**: 如有问题或建议，请提交 Issue
